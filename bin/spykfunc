#!/usr/bin/env bash
# #############################################################################
# Spykfunc - A PySpark implementation of Functionalizer
#
# Author Fernando.pereira@epfl.ch
# Copyright (c) 2017 EPFL - Blue Brain Project
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
###############################################################################

_NAME=$0
BASEDIR=$(dirname $(readlink -f "$0"))

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Syntax: $(basename $0) <recipe_file> <mvd_file> <morpho_dir> <touch_files> [spykfunc_options..., ] -- [args_passed_to_spark_submit, ...]"
    python $BASEDIR/commands.py --help
    exit 2
fi

if [ "$#" -lt 4 ]; then
    echo "ERROR: Wrong number of arguments"
    echo "Syntax: $(basename $0) <recipe_file> <mvd_file> <morpho_dir> <touch_files> [args_passed_to_spark_submit, ...]"
    echo "        $(basename $0) --help"
    exit 2
fi

recipe_file=$1
mvd_file=$2
morpho_dir=$3
touch_files=$4

if ! [[ -f $recipe_file && -f $mvd_file && -d $morpho_dir ]]; then
    echo "ERROR: Arguments are not valid."
    echo "       Be sure recipe_file and mvd_file exist, and morpho_dir is a directory"
    exit 2
fi

# shift positional params (doesn't change $0)
shift 4

# Parameters for spark-submit shall come after "--"
args_to_spykfunc=()
while [[ -n "$1" && $1 != "--" ]]; do
    args_to_spykfunc+=($1)
    shift
done
[ $1 == "--" ] && shift

(set -x; spark-submit \
  "$@" \
  --packages graphframes:graphframes:0.5.0-spark2.1-s_2.11 \
  --jars $BASEDIR/../share/spykfunc/random.jar \
  --conf spark.sql.shuffle.partitions=$((`nproc`*4)) \
    $BASEDIR/commands.py -- \
      $recipe_file \
      $mvd_file \
      $morpho_dir \
      $touch_files \
      ${args_to_spykfunc[@]}
)
